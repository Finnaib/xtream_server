<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            padding: 20px;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0,0,0,0.3);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        h1 { text-align: center; font-size: 2.5rem; margin-bottom: 30px; }
        .info {
            background: rgba(33, 150, 243, 0.3);
            border: 2px solid #2196f3;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .test-box {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .test-box h2 { color: #4fc3f7; margin-bottom: 20px; }
        video {
            width: 100%;
            max-width: 700px;
            height: 400px;
            background: #000;
            border-radius: 10px;
            display: block;
            margin: 20px auto;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            margin: 10px;
        }
        button:hover { transform: scale(1.05); }
        .result {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .success { background: rgba(76, 175, 80, 0.3); border: 2px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.3); border: 2px solid #f44336; }
        .warning { background: rgba(255, 152, 0, 0.3); border: 2px solid #ff9800; }
        code {
            background: rgba(0,0,0,0.5);
            padding: 3px 8px;
            border-radius: 4px;
            color: #4fc3f7;
        }
        .url-box {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç CORS Test - The REAL Issue</h1>

        <div class="info">
            <h2>üí° Why VLC Works But Browser Doesn't</h2>
            <p style="font-size: 1.1rem; line-height: 2;">
                <strong>VLC:</strong> Doesn't care about CORS (Cross-Origin Resource Sharing)<br>
                <strong>Browsers:</strong> Block videos from external sources unless server allows it<br><br>
                <strong>Solution:</strong> Your server must PROXY the stream (not redirect)
            </p>
        </div>

        <div class="test-box">
            <h2>Test 1: Direct URL (Will Fail Due to CORS)</h2>
            <div class="url-box">http://66.102.120.18:8000/play/a008/index.m3u8</div>
            <button onclick="testDirect()">‚ñ∂Ô∏è Try Direct (Will Fail)</button>
            <div id="directResult"></div>
            <video id="videoDirect" controls></video>
        </div>

        <div class="test-box">
            <h2>Test 2: Through Your Proxy (Should Work!)</h2>
            <div class="url-box" id="proxyUrl">Loading...</div>
            <button onclick="testProxy()">‚ñ∂Ô∏è Try Proxied (Should Work!)</button>
            <div id="proxyResult"></div>
            <video id="videoProxy" controls></video>
        </div>

        <div class="test-box">
            <h2>Test 3: Check CORS Headers</h2>
            <button onclick="checkCORS()">üîç Check CORS Headers</button>
            <div id="corsResult"></div>
        </div>

        <div id="solution" style="display: none;">
            <div class="warning">
                <h2>‚ö†Ô∏è CORS Issue Confirmed!</h2>
                <p style="font-size: 1.1rem; margin-top: 15px;">
                    The stream works in VLC but fails in browser due to CORS restrictions.
                </p>
                <p style="margin-top: 15px;"><strong>Fix:</strong></p>
                <ol style="margin: 15px 0; padding-left: 30px; line-height: 2;">
                    <li>Replace live.php with "REAL FIX: live.php with Full Proxy"</li>
                    <li>This version PROXIES streams (doesn't redirect)</li>
                    <li>Adds proper CORS headers</li>
                    <li>Will work in browsers AND VLC</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const baseUrl = window.location.origin + '/xtream_server';
        const directUrl = 'http://66.102.120.18:8000/play/a008/index.m3u8';
        const proxyUrl = `${baseUrl}/live/finn/finn123/1001.m3u8`;

        document.getElementById('proxyUrl').textContent = proxyUrl;

        function testDirect() {
            const video = document.getElementById('videoDirect');
            const result = document.getElementById('directResult');

            result.innerHTML = '<div class="warning">‚è≥ Trying direct URL (will likely fail due to CORS)...</div>';
            video.src = directUrl;

            const timeout = setTimeout(() => {
                result.innerHTML = '<div class="error">‚ùå <strong>FAILED (CORS Error)</strong><br>The source server doesn\'t allow browser access.<br>This is why VLC works but browser doesn\'t!</div>';
                document.getElementById('solution').style.display = 'block';
            }, 5000);

            video.addEventListener('canplay', () => {
                clearTimeout(timeout);
                result.innerHTML = '<div class="success">‚úÖ Direct URL works! (Rare - source allows CORS)</div>';
            }, { once: true });

            video.addEventListener('error', () => {
                clearTimeout(timeout);
                result.innerHTML = '<div class="error">‚ùå <strong>CORS ERROR CONFIRMED!</strong><br>Source blocks browser access.<br>VLC works because it ignores CORS.</div>';
                document.getElementById('solution').style.display = 'block';
            }, { once: true });

            video.load();
        }

        function testProxy() {
            const video = document.getElementById('videoProxy');
            const result = document.getElementById('proxyResult');

            result.innerHTML = '<div class="warning">‚è≥ Testing through your proxy...</div>';
            video.src = proxyUrl;

            const timeout = setTimeout(() => {
                result.innerHTML = '<div class="error">‚ùå Proxy failed - make sure you uploaded the fixed live.php</div>';
            }, 10000);

            video.addEventListener('canplay', () => {
                clearTimeout(timeout);
                result.innerHTML = '<div class="success">‚úÖ <strong>SUCCESS!</strong> Proxy works!<br>Your server is correctly proxying the stream.</div>';
            }, { once: true });

            video.addEventListener('error', (e) => {
                clearTimeout(timeout);
                let errorMsg = 'Unknown error';
                if (video.error) {
                    switch (video.error.code) {
                        case 1: errorMsg = 'ABORTED'; break;
                        case 2: errorMsg = 'NETWORK ERROR'; break;
                        case 3: errorMsg = 'DECODE ERROR'; break;
                        case 4: errorMsg = 'NOT SUPPORTED'; break;
                    }
                }
                result.innerHTML = `<div class="error">‚ùå Proxy error: ${errorMsg}<br>Upload the fixed live.php that PROXIES (doesn't redirect)</div>`;
            }, { once: true });

            video.load();
        }

        async function checkCORS() {
            const result = document.getElementById('corsResult');
            result.innerHTML = '<div class="warning">‚è≥ Checking CORS headers...</div>';

            try {
                // Test direct source
                let html = '<h3>Direct Source CORS:</h3>';
                try {
                    const response = await fetch(directUrl, { method: 'HEAD', mode: 'cors' });
                    const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                    if (corsHeader) {
                        html += `<p class="success">‚úÖ Has CORS header: ${corsHeader}</p>`;
                    } else {
                        html += `<p class="error">‚ùå No CORS header - this is why browser fails!</p>`;
                    }
                } catch (e) {
                    html += `<p class="error">‚ùå CORS blocked: ${e.message}</p>`;
                }

                // Test your proxy
                html += '<h3 style="margin-top: 20px;">Your Proxy CORS:</h3>';
                try {
                    const response = await fetch(proxyUrl, { method: 'HEAD' });
                    const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                    if (corsHeader && corsHeader === '*') {
                        html += `<p class="success">‚úÖ Proxy has CORS: ${corsHeader} (GOOD!)</p>`;
                    } else if (corsHeader) {
                        html += `<p class="warning">‚ö†Ô∏è Proxy has CORS but limited: ${corsHeader}</p>`;
                    } else {
                        html += `<p class="error">‚ùå Proxy missing CORS header - upload fixed live.php!</p>`;
                    }
                } catch (e) {
                    html += `<p class="error">‚ùå Cannot reach proxy: ${e.message}</p>`;
                }

                result.innerHTML = `<div class="result">${html}</div>`;
                document.getElementById('solution').style.display = 'block';

            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>